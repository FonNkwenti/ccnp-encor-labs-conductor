!
! R1 Solution Configuration — BGP Lab 07
! Multihoming & Traffic Engineering
!
hostname R1
!
interface Loopback0
 ip address 172.16.1.1 255.255.255.255
 no shutdown
!
interface Loopback1
 ip address 192.168.1.1 255.255.255.0
 no shutdown
!
interface Loopback2
 ip address 192.168.2.1 255.255.255.0
 no shutdown
!
interface Loopback3
 ip address 192.168.3.1 255.255.255.0
 no shutdown
!
interface FastEthernet0/0
 description Link to R4 (Enterprise Internal)
 ip address 10.1.14.1 255.255.255.252
 no shutdown
!
interface FastEthernet1/0
 description Link to R2 ISP-A Primary
 ip address 10.1.12.1 255.255.255.252
 no shutdown
!
interface FastEthernet1/1
 description Link to R3 ISP-B Backup
 ip address 10.1.13.1 255.255.255.252
 no shutdown
!
router ospf 1
 router-id 172.16.1.1
 network 10.1.14.0 0.0.0.3 area 0
 network 172.16.1.1 0.0.0.0 area 0
!
ip community-list standard CUSTOMER-ROUTES permit 65003:500
!
! Prefix-lists for per-prefix TE matching
ip prefix-list ISP-A-PREFIXES seq 10 permit 198.51.100.0/24
ip prefix-list ISP-A-PREFIXES seq 20 permit 198.51.101.0/24
ip prefix-list ISP-A-PREFIXES seq 30 permit 198.51.102.0/24
ip prefix-list ISP-B-PREFIXES seq 10 permit 203.0.113.0/24
ip prefix-list ISP-B-PREFIXES seq 20 permit 203.0.114.0/24
ip prefix-list ISP-B-PREFIXES seq 30 permit 203.0.115.0/24
ip prefix-list PREFIX-192-168-1 seq 10 permit 192.168.1.0/24
ip prefix-list PREFIX-192-168-2 seq 10 permit 192.168.2.0/24
ip prefix-list PREFIX-192-168-3 seq 10 permit 192.168.3.0/24
ip prefix-list ENTERPRISE-PREFIXES seq 10 permit 192.168.0.0/16 ge 24 le 24
ip prefix-list COND-DEFAULT-CHECK seq 10 permit 198.51.100.0/24
!
! Task 1 — Outbound TE: inbound LP policy from ISP-A
route-map LP-FROM-ISP-A permit 10
 match ip address prefix-list ISP-A-PREFIXES
 set local-preference 200
!
route-map LP-FROM-ISP-A permit 20
 match community CUSTOMER-ROUTES
 set local-preference 120
!
route-map LP-FROM-ISP-A permit 30
 set local-preference 150
!
! Task 1 — Outbound TE: inbound LP policy from ISP-B
route-map LP-FROM-ISP-B permit 10
 match ip address prefix-list ISP-B-PREFIXES
 set local-preference 200
!
route-map LP-FROM-ISP-B permit 20
 match community CUSTOMER-ROUTES
 set local-preference 120
!
route-map LP-FROM-ISP-B permit 30
 set local-preference 150
!
! Task 2+3 — Inbound TE: outbound to ISP-A (prepend 192.168.2, MED per prefix)
route-map TE-TO-ISP-A permit 10
 match ip address prefix-list PREFIX-192-168-2
 set as-path prepend 65001 65001 65001
 set metric 100
!
route-map TE-TO-ISP-A permit 20
 match ip address prefix-list PREFIX-192-168-1
 set metric 10
 set community 65001:100 additive
!
route-map TE-TO-ISP-A permit 30
 match ip address prefix-list PREFIX-192-168-3
 set metric 50
 set community 65001:100 additive
!
route-map TE-TO-ISP-A permit 40
 set community 65001:100 additive
!
! Task 2+3 — Inbound TE: outbound to ISP-B (prepend 192.168.1, MED per prefix)
route-map TE-TO-ISP-B permit 10
 match ip address prefix-list PREFIX-192-168-1
 set as-path prepend 65001 65001 65001
 set metric 100
!
route-map TE-TO-ISP-B permit 20
 match ip address prefix-list PREFIX-192-168-2
 set metric 10
 set community 65001:100 additive
!
route-map TE-TO-ISP-B permit 30
 match ip address prefix-list PREFIX-192-168-3
 set metric 50
 set community 65001:100 additive
!
route-map TE-TO-ISP-B permit 40
 set community 65001:100 additive
!
! Task 4 — Conditional default route origination
route-map COND-DEFAULT permit 10
 match ip address prefix-list COND-DEFAULT-CHECK
!
ip route 0.0.0.0 0.0.0.0 Null0
!
router bgp 65001
 bgp router-id 172.16.1.1
 neighbor 10.1.12.2 remote-as 65002
 neighbor 10.1.12.2 soft-reconfiguration inbound
 neighbor 10.1.12.2 send-community
 neighbor 10.1.12.2 route-map LP-FROM-ISP-A in
 neighbor 10.1.12.2 route-map TE-TO-ISP-A out
 neighbor 10.1.13.2 remote-as 65003
 neighbor 10.1.13.2 soft-reconfiguration inbound
 neighbor 10.1.13.2 send-community
 neighbor 10.1.13.2 route-map LP-FROM-ISP-B in
 neighbor 10.1.13.2 route-map TE-TO-ISP-B out
 neighbor 172.16.4.4 remote-as 65001
 neighbor 172.16.4.4 update-source Loopback0
 neighbor 172.16.4.4 next-hop-self
 neighbor 172.16.4.4 send-community
 neighbor 172.16.4.4 default-originate route-map COND-DEFAULT
 network 172.16.1.1 mask 255.255.255.255
 network 192.168.1.0 mask 255.255.255.0
 network 192.168.2.0 mask 255.255.255.0
 network 192.168.3.0 mask 255.255.255.0
!
line con 0
 logging synchronous
 exec-timeout 0 0
!
end
