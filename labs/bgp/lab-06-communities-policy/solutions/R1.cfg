!
! R1 Solution Configuration
! BGP Lab 06 - BGP Communities & Policy Control
!
hostname R1
!
interface Loopback0
 ip address 172.16.1.1 255.255.255.255
 no shutdown
!
interface Loopback1
 ip address 192.168.1.1 255.255.255.0
 no shutdown
!
interface Loopback2
 ip address 192.168.2.1 255.255.255.0
 no shutdown
!
interface Loopback3
 ip address 192.168.3.1 255.255.255.0
 no shutdown
!
interface FastEthernet0/0
 description Link to R4 (Enterprise Internal)
 ip address 10.1.14.1 255.255.255.252
 no shutdown
!
interface FastEthernet1/0
 description Link to R2 (ISP-A) — Primary
 ip address 10.1.12.1 255.255.255.252
 no shutdown
!
interface FastEthernet1/1
 description Link to R3 (ISP-B) — Backup
 ip address 10.1.13.1 255.255.255.252
 no shutdown
!
router ospf 1
 router-id 172.16.1.1
 network 10.1.14.0 0.0.0.3 area 0
 network 172.16.1.1 0.0.0.0 area 0
!
! AS-path access-lists (inherited from Lab 05)
ip as-path access-list 1 permit ^65002$
ip as-path access-list 2 permit ^65003$
!
! Prefix-lists
ip prefix-list ENTERPRISE-PREFIXES seq 10 permit 192.168.0.0/16 ge 24 le 24
ip prefix-list DENY-203-115 seq 10 permit 203.0.115.0/24
! Task 4: ISP-A internal experimental prefix to tag with local-AS
ip prefix-list ISP-A-INTERNAL seq 10 permit 198.51.102.0/24
!
! Task 4: Inbound from ISP-A — tag ISP-A internal prefix with local-AS, LP 200 for all ISP-A routes
route-map SET-LP-200-ISP-A permit 10
 match ip address prefix-list ISP-A-INTERNAL
 set local-preference 200
 set community local-AS
!
route-map SET-LP-200-ISP-A permit 15
 match as-path 1
 set local-preference 200
!
route-map SET-LP-200-ISP-A permit 20
!
! Inbound from ISP-B (inherited from Lab 05)
route-map POLICY-ISP-B-IN deny 5
 match ip address prefix-list DENY-203-115
!
route-map POLICY-ISP-B-IN permit 10
 match as-path 2
 set local-preference 150
!
route-map POLICY-ISP-B-IN permit 20
!
! Task 1: Outbound to ISP-A — set community 65001:100 on enterprise prefixes
route-map TAG-ISP-A-OUT permit 10
 match ip address prefix-list ENTERPRISE-PREFIXES
 set community 65001:100
!
route-map TAG-ISP-A-OUT permit 20
!
! Task 1: Outbound to ISP-B — set community 65001:200 and prepend AS-path
route-map TAG-AND-PREPEND-ISP-B permit 10
 match ip address prefix-list ENTERPRISE-PREFIXES
 set community 65001:200
 set as-path prepend 65001 65001 65001
!
route-map TAG-AND-PREPEND-ISP-B permit 20
!
router bgp 65001
 bgp router-id 172.16.1.1
 ! eBGP peer R2 (ISP-A) — Task 1: send-community + outbound tag
 neighbor 10.1.12.2 remote-as 65002
 neighbor 10.1.12.2 soft-reconfiguration inbound
 neighbor 10.1.12.2 send-community
 neighbor 10.1.12.2 route-map SET-LP-200-ISP-A in
 neighbor 10.1.12.2 route-map TAG-ISP-A-OUT out
 ! eBGP peer R3 (ISP-B) — Task 1: send-community + outbound tag
 neighbor 10.1.13.2 remote-as 65003
 neighbor 10.1.13.2 soft-reconfiguration inbound
 neighbor 10.1.13.2 send-community
 neighbor 10.1.13.2 route-map POLICY-ISP-B-IN in
 neighbor 10.1.13.2 route-map TAG-AND-PREPEND-ISP-B out
 ! iBGP peer R4 (unchanged)
 neighbor 172.16.4.4 remote-as 65001
 neighbor 172.16.4.4 update-source Loopback0
 neighbor 172.16.4.4 next-hop-self
 !
 network 172.16.1.1 mask 255.255.255.255
 network 192.168.1.0 mask 255.255.255.0
 network 192.168.2.0 mask 255.255.255.0
 network 192.168.3.0 mask 255.255.255.0
!
line con 0
 logging synchronous
 exec-timeout 0 0
!
end
