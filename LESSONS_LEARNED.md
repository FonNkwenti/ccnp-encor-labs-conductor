# Lessons Learned — CCNP ENCOR Lab Development

Patterns, bugs, design decisions, and anti-patterns discovered during development of the CCNP ENCOR (350-401) lab series. Reference this when extending the project or building new certification tracks.

---

## Part 1: Lab Architecture & Standards

### The DeepSeek Standard (Lab Artifact Set)

**What it includes:**
```
labs/[chapter]/lab-NN-[slug]/
├── workbook.md              # Student guide (concepts, topology, objectives, verification, solutions)
├── initial-configs/         # Starting device configs for this lab
│   ├── R1.cfg
│   ├── R2.cfg
│   └── ...
├── solutions/               # Complete reference configs
│   ├── R1.cfg
│   ├── R2.cfg
│   └── ...
├── setup_lab.py             # Netmiko automation to load initial-configs
├── topology.drawio          # Editable diagram (XML)
├── topology.png             # Exported diagram (high-DPI)
└── scripts/
    └── fault-injection/     # Generated by fault-injector skill
        ├── inject_scenario_01.py
        ├── inject_scenario_02.py
        ├── inject_scenario_03.py
        ├── apply_solution.py
        └── README.md
```

**Why this structure:**
- **Workbook first** — student experience is paramount
- **Separate initial-configs & solutions** — enables progressive challenge design
- **setup_lab.py automation** — reduces manual toil, enables CI/CD-like repeatable setups
- **Fault injection scripts** — transforms static labs into interactive troubleshooting practice
- **Topology diagram** — visual reference prevents student confusion about cabling
- **PNG export** — readable in all documentation systems (Markdown, PDFs, web)

**Cost:** More upfront work per lab, but reusable pattern accelerates future labs.

---

### Lab Chaining Rule: "Only Add, Never Remove"

**Design:**
- Lab 1 initial-configs = base IP from baseline.yaml (core devices only)
- Lab 2 initial-configs = copy of Lab 1 solutions/
- Lab 3 initial-configs = copy of Lab 2 solutions/
- ...and so on

**Key constraint:** Never remove configuration commands between labs. Only add.

**Why:**
- Students don't have to reconfigure everything each lab
- Exam simulation (real networks don't reset between scenarios)
- Validates that students' configs are backward-compatible
- Catches accidental regressions

**Gotcha:** If Lab 2 adds a feature that breaks Lab 1's configs, you must redesign Lab 1 to be forward-compatible. This is a feature, not a bug — it teaches defensive configuration.

---

### baseline.yaml as Source of Truth

**Contains:**
- Core topology (devices, interfaces, IPs, console ports)
- Optional devices (added in specific labs)
- Optional links (tunnels, secondary connections)
- Lab progression (which devices active per lab number)
- Tunnel overlays (GRE, IPsec, MPLS definitions)

**Why centralize?**
- Single source prevents topology drift across 8-10 labs
- IP addressing conflicts caught early
- Lab generation scripts can validate against baseline
- Enables "lab N includes devices X, Y, Z" pattern

**Anti-pattern:** Storing topology in each workbook. Results in version mismatch, copy-paste errors, and inconsistent cabling.

---

## Part 2: Skills Architecture

### Skill Structure: YAML Frontmatter → SKILL.md → references/

**Three-level progressive disclosure:**

1. **Level 1 (YAML frontmatter)** — loaded in Claude's system prompt
   - `name` (kebab-case, matches folder name exactly)
   - `description` (WHAT + WHEN — include trigger phrases users say)
   - `metadata` (author, version, category, tags)
   - Result: Claude decides "should I load this skill?" without reading full content

2. **Level 2 (SKILL.md body)** — loaded when Claude thinks skill is relevant
   - Core workflow and instructions
   - Key examples and validation checklist
   - Keep under 5,000 words
   - Result: Focused instructions, no rambling

3. **Level 3 (references/)** — loaded on demand
   - Detailed reference tables
   - Full XML/code snippets
   - Verbose examples and templates
   - Result: Claude navigates to these only when needed

**Common mistake:** Putting all detail in SKILL.md (makes it 800+ lines, wastes tokens, triggers rarely).

**Lesson:** Extract verbose content to `references/` and link with "See `references/[file].md` for..."

---

### Skill name must match folder name

**Rule:** If skill folder is `cisco-troubleshooting-1/`, then YAML `name: cisco-troubleshooting-1`.

**Why it matters:**
- Claude uses folder name to locate skill
- Mismatch causes "skill not found" even though file exists
- Hard to debug (seems like the skill is broken)

**Fixed bug:** Had `name: cisco-troubleshooting` in folder `cisco-troubleshooting-1/` — renamed to match.

---

### Description field must include trigger phrases

**Anti-pattern:**
```yaml
description: Helps with projects.
```
→ Too vague, Claude won't trigger it.

**Good pattern:**
```yaml
description: Generates CCNP ENCOR lab workbooks, initial configs, and setup_lab.py
  automation scripts. Use when asked to "create a lab", "build lab N", "generate a
  workbook", or "make a lab for [topic]".
```
→ Claude knows exactly when to invoke this.

**Why:** The description is the ONLY thing in Claude's system prompt (before SKILL.md is loaded). If it's vague, the skill never triggers.

---

## Part 3: GNS3 on Apple Silicon

### Constraint: Dynamips Only (No VirtualBox/VMware)

**Reality on Apple M1/M2/M3:**
- Native emulation via Dynamips ✓ (works well)
- VirtualBox ✗ (not supported on ARM)
- VMware Fusion ✗ (has limited ARM support, very slow)
- Docker containers ✗ (requires x86 IOS images, incompatible)

**Impact:**
- Platforms: c7200, c3725 only
- No IOS-XR, NX-OS, or heavy containerized features
- Console-only access (no SSH in Dynamips)
- Netmiko `device_type='cisco_ios_telnet'` required

**Platform Recommendation: c7200 for Advanced Labs**
- **Issue:** C3725 platforms are limited to IOS 12.4, which lacks support for modern features like EIGRP Named Mode, advanced SHA authentication, and specific IPv6 features.
- **Solution:** Use **C7200 routers with IOS 15.x** for any advanced technology scenarios or integration labs.
- **Rule:** When designing a `baseline.yaml`, prioritize `c7200` for core routers and any devices intended for advanced feature demonstration (e.g., named mode, IPsec, advanced BGP). Reserve `c3725` only for simple branch or stub devices where basic connectivity is sufficient.

**Lesson:** Document constraints upfront. Don't promise features (like IOS-XE advanced commands) that Dynamips can't support.

---

### Console Ports: Predictable Numbering

**Standard:**
```
R1 → 5001
R2 → 5002
R3 → 5003
...
R7 → 5007
```

**Why:**
- Scriptable (connect to `localhost:500N`)
- Human-readable (port number = router number)
- Avoids conflicts (everyone uses 5000-5010 range)

**In setup_lab.py:**
```python
console_ports = {
    "R1": 5001,
    "R2": 5002,
    # ...
}
```

---

## Part 4: Topology Diagram Standards

### Cisco Icons + White Lines: Visual Identity

**Rules:**
- Use Cisco mxgraph icons (blue fill `#036897`)
- Connection lines ALWAYS white (`#FFFFFF`), never black
- Device labels on the "empty side" (no connection lines crossing)
- Title at top center, legend at bottom-right

**Why white?**
- Cisco official standard (matches design docs)
- Clear visual separation from physical devices
- Professional appearance

**Lesson:** Consistency in diagrams builds trust. Readers instantly recognize "this is a professional Cisco lab."

---

### IP Last-Octet Labels: Instant Recognition

**Pattern:**
```
Link between R1 (10.12.0.1) and R2 (10.12.0.2):
- Edge label: "Fa1/0 - Fa0/0\n10.12.0.0/30"
- Near R1's end: ".1"
- Near R2's end: ".2"
```

**Why:**
- Students instantly see which IP belongs to which router
- No need to calculate or read full subnet label
- Catches IP misconfiguration at a glance

**Gotcha:** Tunnel overlay octets must be positioned NEAR THE TOP of the device (where tunnel arc exits), not on the side like physical links.

---

### Bypass-Link Offset Pattern (Prevent Line-Through-Device)

**Problem:** When R1→R3 link exists but R2 is at same X coordinate between them:
```
R1 (x=400)
|
R2 (x=400)    ← R1→R3 line will pass THROUGH R2 visually
|
R3 (x=400)
```

**Solution:** Offset R2 horizontally:
```
    R1 (x=400)
   / \
  /   \
R2 (x=500)    ← shifted right by ~100px
  \
   \
    R3 (x=400)
```

**Rule:** When a bypass link exists between two devices that have intermediate devices at the same X, shift intermediate device(s) horizontally by 100px.

**Lesson:** Visual clarity in diagrams prevents student confusion about actual topology.

---

### Tunnel Arc Routing: Curve Above, Not Through

**Algorithm for GRE/IPsec tunnel from R1→R6:**
```
arc_y = min(source_y, target_y) - 100  # 100px above the higher device
waypoint_1 = (source_x + 39, arc_y)     # above source
waypoint_2 = (target_x + 39, arc_y)     # above target
```

**Why:**
- Arcs above the physical topology (visual distinction)
- Never crosses through intermediate devices
- Looks professional and unambiguous

**Gotcha:** Using straight lines for tunnels makes the diagram look cluttered and confusing. Always curve.

---

## Part 5: Lab Content Patterns

### Exam-Aligned Terminology

**Use official Cisco terms:**
- ✅ "Feasible Successor", "Administrative Distance", "Dead Interval"
- ❌ "backup route", "backup priority", "keepalive"

**Why:** Students are preparing for exam. Using exam vocabulary reinforces correct terminology and prevents confusion during the test.

**Lesson:** Every word in a lab should reinforce exam objectives. Casual language dilutes learning.

---

### Solution Configs in `<details>` Spoiler Blocks

**Format:**
```markdown
<details>
<summary>Click to view R1 Configuration</summary>

```bash
router ospf 1
 network 1.1.1.0 0.0.0.255 area 0
```

</details>
```

**Why:**
- Students can attempt the lab without accidentally seeing the answer
- Reduces temptation to copy-paste
- Respects the learning process

**Anti-pattern:** Solution configs visible at the top of workbook. Doesn't work.

---

### Verification Cheatsheet: Show Commands

**Standard section in workbook:**
```markdown
## Verification Cheatsheet

| What to Check | Command |
|---------------|---------|
| OSPF neighbors | show ip ospf neighbor |
| Routing table | show ip route ospf |
| Interface status | show ip interface brief |
```

**Why:**
- Quick reference without reading full workbook
- Saves time for labs 5-8 (students remember the pattern)
- Reduces "what command do I run?" questions

---

## Part 6: Troubleshooting Skill Patterns

### Four-Phase Troubleshooting Lifecycle

**Phase 0: Lab Context** → Read workbook.md, identify console ports, understand objectives

**Phase I: Problem Definition** → Transform vague symptoms into precise problem statement

**Phase II: Methodology Selection** → Choose Top-Down, Bottom-Up, Divide & Conquer, Follow Traffic Path, or Compare Configurations

**Phase III: Diagnostic Execution** → Gather evidence, establish baseline, hypothesize, test

**Phase IV: Resolution & Reporting** → Document findings in structured report

**Why four phases?** Prevents random "just try things" approach. Structured method reduces MTTR and prevents introducing new problems.

---

### When Each Methodology Wins

| Scenario | Method | Signal |
|----------|--------|--------|
| Can ping but can't browse | Top-Down | Layer 3 works, check upper layers |
| New device, no connectivity | Bottom-Up | Likely physical/basic config |
| Remote site can't reach HQ | Follow Traffic Path | Multi-hop routing issue |
| One device works, similar one doesn't | Compare Configurations | Reference device available |
| Unknown layer | Divide & Conquer | Start at Layer 3 with ping |

**Lesson:** Methodology choice matters. Wrong choice = wasted time. Right choice = fast diagnosis.

---

## Part 7: Anti-Patterns (What NOT to Do)

### ❌ Random Configuration Changes

**Anti-pattern:**
```
"Hmm, it's not working. Let me just try changing the OSPF cost..."
```

**Why it fails:**
- No hypothesis
- Can introduce new problems
- Hard to debug (what actually fixed it?)

**Correct approach:**
```
"Based on evidence X, I hypothesize Y will fix it. Let me test."
```

---

### ❌ Storing Topology in Workbook

**Anti-pattern:** Each lab has its own topology section, no baseline.yaml.

**Why it fails:**
- Copy-paste errors (IP mismatch, wrong interface)
- Topology drift (lab 5 describes different links than lab 3)
- Difficult to validate

**Correct approach:** baseline.yaml is source of truth, workbook references it.

---

### ❌ No Lab Chaining

**Anti-pattern:** Each lab starts from scratch.

**Why it fails:**
- Students don't learn backward compatibility
- Doesn't simulate real networks (which don't reset)
- Wastes configuration time

**Correct approach:** Lab N initial-configs = Lab N-1 solutions.

---

### ❌ Fault Injection Without Automat Restoration

**Anti-pattern:** Fault injection script changes config but no apply_solution.py to restore.

**Why it fails:**
- Students get stuck in broken state
- No way to start fresh except manual fix
- Discourages practice

**Correct approach:** Every inject_scenario_NN.py has corresponding apply_solution.py.

---

### ❌ Skipping Verification After Fix

**Anti-pattern:**
```
"I changed the config, it should work now."
```

**Why it fails:**
- Doesn't test the actual symptoms
- May have introduced new problems
- No evidence of resolution

**Correct approach:**
```
"I changed the config. Now let me run the original failing test to confirm it passes."
```

---

## Part 8: Recommended Workflow for New Chapters

When adding a new technology (e.g., BGP, FHRP):

1. **Read baseline.yaml** (if chapter exists)
2. **Run chapter-topics-creator skill** to generate blueprint and baseline.yaml
3. **Read the created baseline.yaml** to validate topology and device count
4. **Run chapter-builder skill** to generate all labs at once
5. **Review each workbook.md** for accuracy and exam alignment
6. **Manually test one lab end-to-end** (setup_lab.py → verify → troubleshoot)
7. **Run fault-injector skill** on that lab to generate scenarios
8. **Iterate:** Ask students/reviewers for feedback, update workbooks
9. **Commit** when all labs pass manual validation

**Cost:** ~3-4 hours per chapter (9-10 labs).

**Benefit:** Reusable, maintainable, exam-aligned content.

---

## Part 9: When to Extend vs. Create New

| Scenario | Decision | Reason |
|----------|----------|--------|
| Add OSPF adjacency lab to EIGRP chapter | Create new chapter | Different protocol, different baseline |
| Add OSPF over VPN lab to OSPF chapter | Extend chapter | Same protocol, builds on existing devices |
| Add security (AAA, ACLs) to BGP | Create new chapter | Different focus, different objectives |
| Add OSPF area migration to OSPF | Extend chapter | Same protocol, progressive difficulty |

**Key:** Chapters are tightly scoped by technology. Don't mix protocols unless they're interdependent (e.g., OSPF-to-EIGRP redistribution).

---

## Part 10: Testing Strategy

### Manual Validation Checklist

Before committing a lab:

- [ ] All IP addresses from baseline.yaml
- [ ] setup_lab.py loads initial-configs without errors
- [ ] Student can complete all objectives
- [ ] Verification cheatsheet commands work
- [ ] Solutions section has all objectives covered
- [ ] Fault injection scripts run without hanging
- [ ] apply_solution.py restores correct state
- [ ] topology.drawio renders correctly (all white lines, Cisco icons)
- [ ] All workbook spelling and grammar correct

### No Automated Tests (Yet)

**Why:** Network configuration changes are state-dependent. Hard to unit test without live GNS3 lab running.

**Future consideration:** pytest framework to validate:
- topology.drawio XML structure
- baseline.yaml schema validation
- initial-configs/ have matching devices
- Workbook has required sections

---

## Part 11: Common Bugs & Fixes

### Bug: OSPF Neighbors Stuck in INIT State

**Causes:**
1. Hello/Dead timer mismatch (most common)
2. Authentication mismatch
3. Network statement too narrow (doesn't include interface subnet)
4. Interface passive

**Check first:**
```
show ip ospf interface [intf]
show ip ospf neighbor
show running-config | section ospf
```

---

### Bug: EIGRP Neighbor Flapping

**Causes:**
1. AS mismatch
2. K-values mismatch
3. Passive interface misconfiguration
4. MTU mismatch (EIGRP fragments aggressively)

**Check first:**
```
show ip eigrp neighbors detail
show ip eigrp interface detail
show running-config | section eigrp
```

---

### Bug: Tunnel Down/Down

**Causes:**
1. Tunnel source/destination IPs unreachable
2. Recursive routing (tunnel destination learned through tunnel)
3. MTU mismatch (tunnel packets fragmented then dropped)

**Check first:**
```
ping [tunnel-source-ip]
ping [tunnel-dest-ip]
show ip route [tunnel-dest]
show interface tunnel [N]
```

---

## Part 12: Recommended Reading

- **Cisco CCNP ENCOR Official Study Guide** — exam blueprint authority
- **RFC 2328** (OSPF), **RFC 7868** (EIGRP) — protocol details
- **GNS3 Documentation** — console access, Dynamips quirks
- **Netmiko Documentation** — device_type options, send_config_set() behavior

---

## Part 13: Workflow & Process Lessons

### The "Claude Code" Influence (February 2026)

**Strategy: Plan Node Default**
- **Lesson:** Stop being a "cowboy coder." Any task with >3 steps or architectural implications MUST have a documented plan update in `plan.md` (track) or `tasks/todo.md` (global) first.
- **Why:** Reduces context switching and clarifies the "definition of done" before a single line of code is written.

**Strategy: Self-Improvement Loop**
- **Lesson:** Update `tasks/lessons.md` immediately after any user correction or when a better process is identified.
- **Rule:** If a user says "don't do X, do Y," capture it in the process log. Review this file at the start of every session.
- **Success Metric:** Mistake rate should drop towards zero for repeated workflow tasks.

**Strategy: Demand Elegance**
- **Lesson:** Before implementation, pause for 10 seconds. Ask: "Is this the most elegant way?"
- **Constraint:** Don't over-engineer simple fixes, but don't tolerate "hacky" solutions for core architecture.

**Strategy: Autonomous Bug Fixing (Fix on Evidence)**
- **Lesson:** Don't ask for permission to fix a bug if you have clear evidence (logs, failing tests).
- **Rule:** Fix the root cause, not just the symptom. Proactively resolve CI failures.

---

## Summary: The North Star

> **Excellence in lab design = Clarity in student outcome + Respect for student time + Alignment with exam reality.**

Every design decision should ask:
1. Does this help the student learn the exam objective?
2. Does this respect the student's time (no busywork)?
3. Does this simulate real network behavior?

If the answer to all three is "yes," build it. If any is "no," reconsider.

---

**Last Updated:** February 2026
**Applicable to:** CCNP ENCOR 350-401 (and other Cisco certification tracks that follow this pattern)
